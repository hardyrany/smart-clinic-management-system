name: Compile Backend and Run Code Quality Checks

# Trigger workflow on pushes to main branch and pull requests targeting main
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Java 17 using Temurin distribution
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      # Step 3: Cache Maven dependencies to speed up builds
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('backend/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Step 4: Make Maven wrapper executable (required for Linux runners)
      - name: Make Maven wrapper executable
        run: chmod +x ./backend/mvnw

      # Step 5: Compile backend source code without packaging
      - name: Compile Backend Code
        run: ./mvnw clean compile
        working-directory: backend

      # Step 6: Build backend JAR without running tests
      - name: Build Backend with Maven Wrapper
        run: ./mvnw clean install -DskipTests
        working-directory: backend

      # Step 7: Run unit tests to ensure code quality
      - name: Run Backend Tests with Maven Wrapper
        run: ./mvnw test
        working-directory: backend

      # Step 8: Run Checkstyle to verify coding standards
      - name: Run Checkstyle
        run: ./mvnw checkstyle:check
        working-directory: backend

      # Step 9: Run SpotBugs to catch potential bugs
      - name: Run SpotBugs
        run: ./mvnw spotbugs:check
        working-directory: backend